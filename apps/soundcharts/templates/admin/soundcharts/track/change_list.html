{% extends "admin/change_list.html" %}
{% load i18n admin_urls static %}

{% block object-tools-items %}
  {% if show_bulk_metadata_button %}
      <a href="{% url 'admin:soundcharts_track_import' %}" class="addlink btn btn-info">
        {% trans 'Import from API' %}
      </a>
      <a href="#" onclick="createBulkMetadataTask(); return false;" class="addlink btn btn-info">
        {% trans 'Fetch All Metadata' %}
      </a>
      <a href="#" onclick="createBulkAudienceTask(); return false;" class="addlink btn btn-info">
        {% trans 'Fetch All Audience Data' %}
      </a>
      {% endif %}
  {{ block.super }}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "assets/admin-import.css" %}">
<script src="{% static "assets/track-admin-alerts.js" %}"></script>
<script>
function createBulkMetadataTask() {
    if (confirm('{% trans "This will create a background task to fetch metadata for all tracks that need it. Continue?" %}')) {
        // Get all track UUIDs from the current page
        const checkboxes = document.querySelectorAll('input[name="_selected_action"]:checked');
        if (checkboxes.length === 0) {
            showTrackAlert('{% trans "Please select at least one track to fetch metadata for." %}', 'warning');
            return;
        }
        
        // Submit the form with the bulk metadata action
        const form = document.getElementById('changelist-form');
        const actionSelect = document.getElementById('action');
        actionSelect.value = 'create_bulk_metadata_task';
        form.submit();
    }
}

function createBulkAudienceTask() {
    if (confirm('{% trans "This will create a background task to fetch audience data for all tracks that need it. Continue?" %}')) {
        // Submit the form with the bulk audience action
        const form = document.getElementById('changelist-form');
        const actionSelect = document.getElementById('action');
        actionSelect.value = 'create_bulk_audience_task';
        form.submit();
    }
}
</script>
{% endblock %}
