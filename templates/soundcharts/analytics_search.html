{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">

<main>
  <div class="px-4 pt-6">
    <!-- Header Section -->
    <div class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Music Analytics</h1>
          <p class="text-gray-600 dark:text-gray-400">Aggregate artist audience metrics across platforms and time periods</p>
        </div>
      </div>
    </div>

    <!-- Search Form -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-6 mb-6">
      <form id="analytics-search-form">
        <!-- Artists Selection -->
        <div class="mb-6">
          <label for="artistSearch" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Select Artists <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2 mb-2">
            <input type="text" 
                   id="artistSearch" 
                   placeholder="Search artists by name..." 
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                   autocomplete="off">
          </div>
          <div id="selected-artists" class="flex flex-wrap gap-2 mt-2 min-h-[40px]">
            <!-- Selected artists will appear here -->
          </div>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            ℹ️ Only artists with SoundCharts UUIDs can be selected (required for API access)
          </p>
        </div>

        <!-- Date Range -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              Start Date <span class="text-red-500">*</span>
            </label>
            <input type="date" 
                   id="start-date" 
                   name="start_date"
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                   required>
          </div>
          <div>
            <label for="end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              End Date <span class="text-red-500">*</span>
            </label>
            <input type="date" 
                   id="end-date" 
                   name="end_date"
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                   required>
          </div>
        </div>

        <!-- Platforms Selection -->
        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Platforms <span class="text-red-500">*</span>
          </label>
          <div class="flex items-center mb-2">
            <input type="checkbox" 
                   id="select-all-platforms" 
                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600">
            <label for="select-all-platforms" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
              Select All
            </label>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
            {% for platform in platforms %}
            <div class="flex items-center p-2 border border-gray-200 rounded-lg dark:border-gray-700">
              <input type="checkbox" 
                     name="platform_ids" 
                     value="{{ platform.id }}" 
                     id="platform-{{ platform.id }}"
                     class="platform-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600">
              <label for="platform-{{ platform.id }}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
                {{ platform.name }}
              </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Country Filter (Informational) -->
        <div class="mb-6">
          <label for="country" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Country (Informational)
          </label>
          <select id="country" 
                  name="country"
                  class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">All Countries</option>
            {% for country_code in countries %}
            <option value="{{ country_code }}">{{ country_code }}</option>
            {% endfor %}
          </select>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            ℹ️ Shows audience data for the selected country (available for Spotify & YouTube). Leave blank for global data.
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex items-center gap-4">
          <button type="submit" 
                  id="search-button"
                  class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Analyze Metrics
          </button>
        </div>
      </form>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
      <div class="flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-blue-800 dark:text-blue-200">Analyzing metrics...</span>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-red-800 dark:text-red-200" id="error-message">An error occurred</span>
      </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="hidden">
      <!-- Results will be loaded here -->
    </div>
  </div>
</main>

{% endblock content %}

{% block extra_js %}
<script>
const CSRF_TOKEN = document.querySelector('[name=csrf-token]').content;

// Selected artists storage
let selectedArtists = [];
let artistSearchTimeout = null;

// Artist autocomplete
document.getElementById('artistSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        document.getElementById('artist-suggestions').classList.add('hidden');
        return;
    }
    
    // Debounce search
    clearTimeout(artistSearchTimeout);
    artistSearchTimeout = setTimeout(() => {
        searchArtists(query);
    }, 300);
});

function searchArtists(query) {
    fetch(`/soundcharts/analytics/api/artist-autocomplete/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.artists.length > 0) {
                displayArtistSuggestions(data.artists);
            }
        })
        .catch(error => console.error('Artist search error:', error));
}

function displayArtistSuggestions(artists) {
    // Create suggestions dropdown if it doesn't exist
    let dropdown = document.getElementById('artist-suggestions');
    if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'artist-suggestions';
        dropdown.className = 'absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg dark:bg-gray-700 dark:border-gray-600 max-h-60 overflow-y-auto';
        document.getElementById('artistSearch').parentElement.appendChild(dropdown);
    }
    
    dropdown.innerHTML = artists.map(artist => {
        const imageHtml = artist.imageUrl 
            ? `<img src="${artist.imageUrl}" class="w-10 h-10 rounded-full object-cover mr-3" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
               <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3 text-gray-600 dark:text-gray-300 font-bold" style="display:none;">${artist.name.charAt(0).toUpperCase()}</div>`
            : `<div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3 text-gray-600 dark:text-gray-300 font-bold">${artist.name.charAt(0).toUpperCase()}</div>`;
        
        return `
        <div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center" 
             onclick='selectArtist(${JSON.stringify(artist)})'>
            ${imageHtml}
            <div>
                <div class="text-sm font-medium text-gray-900 dark:text-white">${artist.name}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${artist.countryCode || 'N/A'}</div>
            </div>
        </div>
        `;
    }).join('');
    
    dropdown.classList.remove('hidden');
}

function selectArtist(artist) {
    // Check if already selected
    if (selectedArtists.find(a => a.id === artist.id)) {
        return;
    }
    
    selectedArtists.push(artist);
    renderSelectedArtists();
    
    // Clear search
    document.getElementById('artistSearch').value = '';
    document.getElementById('artist-suggestions').classList.add('hidden');
}

function removeArtist(artistId) {
    selectedArtists = selectedArtists.filter(a => a.id !== artistId);
    renderSelectedArtists();
}

function renderSelectedArtists() {
    const container = document.getElementById('selected-artists');
    container.innerHTML = selectedArtists.map(artist => {
        const imageHtml = artist.imageUrl 
            ? `<img src="${artist.imageUrl}" class="w-5 h-5 rounded-full object-cover mr-2" onerror="this.style.display='none';">`
            : `<div class="w-5 h-5 rounded-full bg-blue-200 dark:bg-blue-700 flex items-center justify-center mr-2 text-xs font-bold">${artist.name.charAt(0).toUpperCase()}</div>`;
        
        return `
        <div class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full dark:bg-blue-900 dark:text-blue-200">
            ${imageHtml}
            <span class="text-sm font-medium">${artist.name}</span>
            <button type="button" 
                    onclick="removeArtist(${artist.id})"
                    class="ml-2 text-blue-600 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-100">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        `;
    }).join('');
}

// Select all platforms
document.getElementById('select-all-platforms').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.platform-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Form submission
document.getElementById('analytics-search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate
    if (selectedArtists.length === 0) {
        showError('Please select at least one artist');
        return;
    }
    
    const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked')).map(cb => cb.value);
    if (selectedPlatforms.length === 0) {
        showError('Please select at least one platform');
        return;
    }
    
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
        showError('Please select both start and end dates');
        return;
    }
    
    // Submit
    submitAnalyticsSearch({
        artist_ids: selectedArtists.map(a => a.id),
        platform_ids: selectedPlatforms,
        start_date: startDate,
        end_date: endDate,
        country: document.getElementById('country').value
    });
});

function submitAnalyticsSearch(data) {
    // Show loading
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('search-button').disabled = true;
    
    fetch('/soundcharts/analytics/results/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw { status: response.status, data: err };
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Display results inline
            displayResults(result.data, data);
        } else {
            showDetailedError(result);
        }
    })
    .catch(error => {
        console.error('Analytics search error:', error);
        if (error.data) {
            showDetailedError(error.data);
        } else {
            showError('An error occurred while analyzing metrics: ' + error.message);
        }
    })
    .finally(() => {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('search-button').disabled = false;
    });
}

function displayResults(data, searchParams) {
    console.log('Displaying results:', data);
    
    // Format number helper
    const formatNumber = (value) => {
        if (!value) return 'N/A';
        if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
        if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
        if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
        return Math.floor(value).toLocaleString();
    };
    
    // Platform colors for visual distinction
    const platformColors = {
        'spotify': { bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', text: 'text-green-700 dark:text-green-300', badge: 'bg-green-600' },
        'youtube': { bg: 'bg-red-50 dark:bg-red-900/20', border: 'border-red-200 dark:border-red-800', text: 'text-red-700 dark:text-red-300', badge: 'bg-red-600' },
        'instagram': { bg: 'bg-pink-50 dark:bg-pink-900/20', border: 'border-pink-200 dark:border-pink-800', text: 'text-pink-700 dark:text-pink-300', badge: 'bg-pink-600' },
        'tiktok': { bg: 'bg-gray-50 dark:bg-gray-900/20', border: 'border-gray-200 dark:border-gray-800', text: 'text-gray-700 dark:text-gray-300', badge: 'bg-gray-600' },
        'facebook': { bg: 'bg-blue-50 dark:bg-blue-900/20', border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-700 dark:text-blue-300', badge: 'bg-blue-600' },
        'twitter': { bg: 'bg-cyan-50 dark:bg-cyan-900/20', border: 'border-cyan-200 dark:border-cyan-800', text: 'text-cyan-700 dark:text-cyan-300', badge: 'bg-cyan-600' },
        'airplay': { bg: 'bg-purple-50 dark:bg-purple-900/20', border: 'border-purple-200 dark:border-purple-800', text: 'text-purple-700 dark:text-purple-300', badge: 'bg-purple-600' },
        'radio': { bg: 'bg-purple-50 dark:bg-purple-900/20', border: 'border-purple-200 dark:border-purple-800', text: 'text-purple-700 dark:text-purple-300', badge: 'bg-purple-600' }
    };
    
    const getPlatformColor = (slug) => platformColors[slug] || platformColors['spotify'];
    
    // Render per-platform summary cards
    const renderPlatformSummaryCards = (data) => {
        // Group data by platform
        const platformData = {};
        
        data.detailed_breakdown.forEach(item => {
            const platformSlug = item.platform__slug;
            if (!platformData[platformSlug]) {
                platformData[platformSlug] = {
                    name: item.platform__name,
                    slug: platformSlug,
                    metric_name: item.platform__audience_metric_name || 'Listeners',
                    start: item.first_value || 0,
                    end: item.latest_value || 0,
                    diff: item.difference || 0,
                    avg: item.month_average || 0,
                    peak: item.peak_value || 0,
                    data_points: item.data_points || 0
                };
            } else {
                // If multiple artists, sum the values
                platformData[platformSlug].start += item.first_value || 0;
                platformData[platformSlug].end += item.latest_value || 0;
                platformData[platformSlug].diff += item.difference || 0;
                platformData[platformSlug].avg += item.month_average || 0;
                platformData[platformSlug].peak = Math.max(platformData[platformSlug].peak, item.peak_value || 0);
            }
        });
        
        // Render card groups for each platform
        let cardsHTML = '';
        Object.values(platformData).forEach(platform => {
            const colors = getPlatformColor(platform.slug);
            
            cardsHTML += `
                <div class="mb-6">
                    <div class="flex items-center mb-3">
                        <span class="${colors.badge} text-white text-xs font-bold px-3 py-1 rounded-full mr-2">
                            ${platform.name}
                        </span>
                        <span class="text-sm text-gray-600 dark:text-gray-400">${platform.metric_name}</span>
                    </div>
                    <div class="grid gap-3 md:grid-cols-3 lg:grid-cols-6">
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">Start</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">${platform.metric_name} at start date</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">${formatNumber(platform.start)}</p>
                        </div>
                        
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">End</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">${platform.metric_name} at end date</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">${formatNumber(platform.end)}</p>
                        </div>
                        
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">Diff</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Growth from start to end</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold ${platform.diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${platform.diff >= 0 ? '+' : ''}${formatNumber(platform.diff)}
                            </p>
                        </div>
                        
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">Average</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Average across period - use for "how much in September"</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold text-blue-600 dark:text-blue-400">${formatNumber(platform.avg)}</p>
                        </div>
                        
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">Peak</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Highest value in period</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold text-purple-600 dark:text-purple-400">${formatNumber(platform.peak)}</p>
                        </div>
                        
                        <div class="border ${colors.border} ${colors.bg} rounded-lg shadow-sm p-3">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-xs font-medium ${colors.text}">Days</h3>
                                <div class="tooltip-wrapper">
                                    <svg class="w-3 h-3 ${colors.text} cursor-help" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Number of days tracked</span>
                                </div>
                            </div>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">${platform.data_points}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        return cardsHTML;
    };
    
    // Build period context
    const periodContext = searchParams.country 
        ? `${data.date_range.start} to ${data.date_range.end} | ${data.metadata.platforms.map(p => p.name).join(', ')} | ${searchParams.country}`
        : `${data.date_range.start} to ${data.date_range.end} | ${data.metadata.platforms.map(p => p.name).join(', ')} | Global`;
    
    const resultsHTML = `
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
                ${data.metadata.artists.map(a => a.name).join(', ')}
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">
                📅 ${periodContext}
            </p>
        </div>

        <!-- Data Type Note -->
        <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-800">
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                <strong>📊 Data Type:</strong> These metrics show <strong>Monthly Listeners</strong> (unique people) for Spotify/YouTube, 
                not total streams/views. Monthly Listeners = unique listeners in a 28-day rolling window.
            </p>
        </div>

        <!-- Summary Cards Per Platform -->
        ${renderPlatformSummaryCards(data)}

        <!-- Legacy summary cards removed - now showing per-platform cards above -->
        <div class="hidden grid gap-4 md:grid-cols-3 lg:grid-cols-6 mb-6">
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">Start Value</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Monthly listeners as of start date (${data.date_range.start})</span>
                    </div>
                </div>
                <p class="text-xl font-bold text-gray-900 dark:text-white">${formatNumber(data.summary.start_value)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${data.date_range.start}</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">End Value</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Monthly listeners as of end date (${data.date_range.end})</span>
                    </div>
                </div>
                <p class="text-xl font-bold text-gray-900 dark:text-white">${formatNumber(data.summary.end_value)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${data.date_range.end}</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">Difference</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Growth from start to end (End - Start). Shows if audience grew or declined.</span>
                    </div>
                </div>
                <p class="text-xl font-bold ${data.summary.difference >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${data.summary.difference >= 0 ? '+' : ''}${formatNumber(data.summary.difference)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${data.summary.difference >= 0 ? 'Growth' : 'Decline'}</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">Period Average</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Average monthly listeners across all days in the period. Use this to answer "how much in September"</span>
                    </div>
                </div>
                <p class="text-xl font-bold text-blue-600 dark:text-blue-400">${formatNumber(data.summary.period_average)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Monthly average</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">Peak</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Highest monthly listeners during the period. Shows best day's performance.</span>
                    </div>
                </div>
                <p class="text-xl font-bold text-purple-600 dark:text-purple-400">${formatNumber(data.summary.peak_value)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Best day</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-xs font-medium text-gray-600 dark:text-gray-400">Data Points</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Number of daily data points from SoundCharts API in the selected period</span>
                    </div>
                </div>
                <p class="text-xl font-bold text-gray-900 dark:text-white">${data.metadata.total_data_points || 0}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Days tracked</p>
            </div>
        </div>

        <!-- Metric Explanations (Collapsible) -->
        <div class="mb-4">
            <button onclick="toggleExplanations(event)" 
                    class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                <svg id="explain-icon" class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                What do these metrics mean?
            </button>
            <div id="metric-explanations" class="hidden mt-2 p-4 bg-gray-50 border border-gray-200 rounded-lg dark:bg-gray-800 dark:border-gray-700">
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📅 Start Value</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Monthly listeners as of the <strong>start date</strong> (${data.date_range.start}). 
                            This is your baseline at the beginning of the period.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📅 End Value</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Monthly listeners as of the <strong>end date</strong> (${data.date_range.end}). 
                            This shows where the artist finished the period.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">🔼 Difference</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Change from start to end (<strong>End - Start</strong>). 
                            Green = growing audience, Red = declining. Shows trend direction.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📊 Period Average</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Average monthly listeners across <strong>all ${data.date_range.days} days</strong>. 
                            Use this to answer "How much in September?"
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">⭐ Peak</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Highest monthly listeners during the period. Shows the best day's performance.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📈 Data Points</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Number of daily measurements from SoundCharts API. Should match number of days in period.
                        </p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 space-y-2">
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <strong>📌 Understanding "Monthly Listeners" (Spotify/YouTube):</strong>
                    </p>
                    <ul class="text-xs text-gray-600 dark:text-gray-400 ml-4 space-y-1">
                        <li>• <strong>NOT total streams/views</strong> - it's unique listener/viewer count</li>
                        <li>• <strong>28-day rolling window</strong> - each date shows listeners from that date back 28 days</li>
                        <li>• <strong>Example:</strong> "107.9M on Sept 2" = 107.9M people listened between Aug 5 - Sept 2</li>
                        <li>• <strong>Updates daily</strong> - new 28-day window calculated each day</li>
                    </ul>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
                        <strong>💡 Best Answer for "How much in September?"</strong><br>
                        Use <strong>Period Average</strong> = Average monthly listeners throughout the month.
                        ${searchParams.country ? '<br><strong>🌍 Country Filter Active:</strong> All data shown is for ' + searchParams.country + ' only.' : ''}
                    </p>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-3 p-2 bg-green-50 dark:bg-green-900/20 rounded border border-green-200 dark:border-green-800">
                        <p class="mb-2"><strong>✅ Now Available: Track Stream Aggregation</strong></p>
                        <p class="mb-2">The "Track Streams" column shows the <strong>total streams/plays</strong> across all of the artist's tracks from chart data.</p>
                        <ul class="ml-4 space-y-1">
                            <li><strong>Monthly Listeners (columns 1-6):</strong> Unique people who listened in a 28-day window</li>
                            <li><strong>Track Streams (column 8):</strong> Total number of times all tracks were played (from charts)</li>
                            <li><strong>Relationship:</strong> "Track Streams" ÷ "Monthly Listeners" ≈ how many times each person played the music on average</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Artist × Platform Breakdown -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Artist × Platform Metrics</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            ${periodContext}
                        </p>
                    </div>
                    <button onclick="exportToExcel()" 
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Artist</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <div>Platform</div>
                                <div class="text-xs normal-case text-gray-400 font-normal">(Metric Type)</div>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Monthly listeners at start date">
                                    Start
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Monthly listeners at end date">
                                    End
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Change from start to end">
                                    Diff
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Average across period">
                                    Avg
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Highest value in period">
                                    Peak
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Total track streams from chart data">
                                    Track Streams
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                        ${data.detailed_breakdown.map((d, index) => {
                            const diff = d.difference || 0;
                            const diffFormatted = diff >= 0 ? '+' + formatNumber(diff) : formatNumber(diff);
                            const diffColor = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                            
                            // Determine metric type based on platform
                            const metricType = d.platform__audience_metric_name || 
                                             (d.platform__slug === 'spotify' || d.platform__slug === 'youtube' ? 'Monthly Listeners' : 'Followers');
                            
                            const rowId = 'row-' + d.artist__uuid + '-' + d.platform__slug;
                            const tracksRowId = 'tracks-' + d.artist__uuid + '-' + d.platform__slug;
                            
                            // Check if track stream data is available
                            const totalTrackStreams = d.total_track_streams || 0;
                            const hasTrackData = totalTrackStreams > 0;
                            
                            return `
                            <tr id="${rowId}" class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                                    <button onclick="toggleTrackBreakdown('${d.artist__uuid}', '${d.platform__slug}', event)" 
                                            class="flex items-center text-left hover:text-blue-600 dark:hover:text-blue-400">
                                        <svg id="expand-icon-${tracksRowId}" class="w-4 h-4 mr-2 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                        ${d.artist__name}
                                    </button>
                                </td>
                                <td class="px-6 py-4 text-sm">
                                    <div class="font-medium text-gray-900 dark:text-white">${d.platform__name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${metricType}</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-right text-gray-900 dark:text-white">${formatNumber(d.first_value)}</td>
                                <td class="px-6 py-4 text-sm text-right text-gray-900 dark:text-white font-medium">${formatNumber(d.latest_value)}</td>
                                <td class="px-6 py-4 text-sm text-right font-medium ${diffColor}">${diffFormatted}</td>
                                <td class="px-6 py-4 text-sm text-right text-blue-600 dark:text-blue-400 font-medium">${formatNumber(d.month_average)}</td>
                                <td class="px-6 py-4 text-sm text-right text-gray-500 dark:text-gray-400">${formatNumber(d.peak_value)}</td>
                                <td class="px-6 py-4 text-sm text-right ${hasTrackData ? 'text-purple-600 dark:text-purple-400 font-medium' : 'text-gray-300 dark:text-gray-600'}">
                                    ${hasTrackData ? formatNumber(totalTrackStreams) : 'N/A'}
                                </td>
                            </tr>
                            <tr id="${tracksRowId}" class="hidden bg-gray-50 dark:bg-gray-900">
                                <td colspan="8" class="px-6 py-4">
                                    <div id="tracks-content-${tracksRowId}" class="text-sm">
                                        <!-- Track breakdown will load here -->
                                    </div>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('results-container').innerHTML = resultsHTML;
    document.getElementById('results-container').classList.remove('hidden');
    
    // Store data for Excel export
    window.currentAnalyticsData = data;
    window.currentSearchParams = searchParams;
    
    // Scroll to results
    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleExplanations(event) {
    event.preventDefault();
    const explanations = document.getElementById('metric-explanations');
    explanations.classList.toggle('hidden');
}

// Phase 2: Track Breakdown Toggle
const trackDataCache = {};

function toggleTrackBreakdown(artistUuid, platformSlug, event) {
    event.preventDefault();
    event.stopPropagation();
    
    const tracksRowId = `tracks-${artistUuid}-${platformSlug}`;
    const tracksRow = document.getElementById(tracksRowId);
    const expandIcon = document.getElementById(`expand-icon-${tracksRowId}`);
    const contentDiv = document.getElementById(`tracks-content-${tracksRowId}`);
    
    if (!tracksRow) {
        console.error('Tracks row not found:', tracksRowId);
        return;
    }
    
    // Toggle visibility
    if (tracksRow.classList.contains('hidden')) {
        // Expand - load data if not cached
        tracksRow.classList.remove('hidden');
        expandIcon.classList.add('rotate-90');
        
        const cacheKey = artistUuid + '-' + platformSlug;
        if (trackDataCache[cacheKey]) {
            // Use cached data
            renderTrackBreakdown(contentDiv, trackDataCache[cacheKey]);
        } else {
            // Load from API
            loadTrackBreakdown(artistUuid, platformSlug, contentDiv);
        }
    } else {
        // Collapse
        tracksRow.classList.add('hidden');
        expandIcon.classList.remove('rotate-90');
    }
}

function loadTrackBreakdown(artistUuid, platformSlug, contentDiv) {
    // Show loading state
    let loadingHtml = '<div class="flex items-center justify-center py-8">';
    loadingHtml += '<svg class="animate-spin h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">';
    loadingHtml += '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>';
    loadingHtml += '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>';
    loadingHtml += '</svg>';
    loadingHtml += '<span class="ml-3 text-gray-600 dark:text-gray-400">Loading track data...</span>';
    loadingHtml += '</div>';
    contentDiv.innerHTML = loadingHtml;
    
    // Find artist and platform IDs from the current data
    const breakdownItem = window.currentAnalyticsData.detailed_breakdown.find(
        d => d.artist__uuid === artistUuid && d.platform__slug === platformSlug
    );
    
    if (!breakdownItem) {
        contentDiv.innerHTML = '<p class="text-red-600">Error: Could not find artist/platform data</p>';
        return;
    }
    
    // Get artist ID from metadata
    const artist = window.currentAnalyticsData.metadata.artists.find(a => a.uuid === artistUuid);
    const platform = window.currentAnalyticsData.metadata.platforms.find(p => p.slug === platformSlug);
    
    if (!artist || !platform) {
        contentDiv.innerHTML = '<p class="text-red-600">Error: Artist or platform not found</p>';
        return;
    }
    
    // Fetch track data
    const params = new URLSearchParams({
        artist_id: artist.id,
        platform_id: platform.id,
        start_date: window.currentSearchParams.start_date,
        end_date: window.currentSearchParams.end_date,
        country: window.currentSearchParams.country || ''
    });
    
    fetch('/soundcharts/analytics/api/track-breakdown/?' + params.toString())
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Cache the result
                const cacheKey = artistUuid + '-' + platformSlug;
                trackDataCache[cacheKey] = result;
                renderTrackBreakdown(contentDiv, result);
            } else {
                renderTrackBreakdownError(contentDiv, result.error);
            }
        })
        .catch(error => {
            console.error('Error loading track breakdown:', error);
            renderTrackBreakdownError(contentDiv, 'Failed to load track data');
        });
}

function renderTrackBreakdown(contentDiv, data) {
    const formatNumber = (value) => {
        if (!value) return '0';
        if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
        if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
        if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
        return Math.floor(value).toLocaleString();
    };
    
    let html = '<div class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<h4 class="text-md font-bold text-gray-900 dark:text-white">';
    html += '🎵 Track Breakdown: ' + data.artist.name + ' on ' + data.platform.name;
    html += '</h4>';
    html += '<div class="text-sm text-gray-600 dark:text-gray-400">';
    html += '<strong>Total Streams:</strong> ' + formatNumber(data.summary.total_streams);
    html += ' <span class="ml-2">(' + data.summary.total_tracks + ' tracks)</span>';
    html += '</div></div>';
    
    if (data.tracks && data.tracks.length > 0) {
        // Detect if this is radio data
        const isRadio = data.data_source === 'radio_api' || data.platform.slug === 'airplay' || data.platform.slug === 'radio';
        const metricLabel = isRadio ? 'Total Spins' : 'Total Streams';
        const positionLabel = isRadio ? 'Stations' : 'Best Position';
        const chartLabel = isRadio ? 'Days Aired' : 'Weeks on Chart';
        
        html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">';
            html += '<thead class="bg-gray-100 dark:bg-gray-700"><tr>';
            html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300">Track</th>';
            html += '<th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300">' + metricLabel + '</th>';
            html += '<th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300">Avg Daily</th>';
            html += '<th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300">Peak</th>';
            html += '<th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300">' + positionLabel + '</th>';
            html += '<th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300">' + chartLabel + '</th>';
            html += '<th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300">Entry Date</th>';
            html += '<th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300">Last Seen</th>';
            html += '</tr></thead>';
        html += '<tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">';
        
        data.tracks.forEach((track, idx) => {
            html += '<tr class="hover:bg-gray-100 dark:hover:bg-gray-700">';
            html += '<td class="px-4 py-2 text-sm">';
            html += '<div class="font-medium text-gray-900 dark:text-white">' + track.track_name + '</div>';
            if (track.track_credit) {
                html += '<div class="text-xs text-gray-500 dark:text-gray-400">' + track.track_credit + '</div>';
            }
            if (idx === 0) {
                html += '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded dark:bg-yellow-900 dark:text-yellow-200">Top Track</span>';
            }
            html += '</td>';
            html += '<td class="px-4 py-2 text-sm text-right font-medium text-gray-900 dark:text-white">' + formatNumber(track.total_streams) + '</td>';
            html += '<td class="px-4 py-2 text-sm text-right text-gray-600 dark:text-gray-400">' + formatNumber(track.avg_daily_streams) + '</td>';
            html += '<td class="px-4 py-2 text-sm text-right text-gray-600 dark:text-gray-400">' + formatNumber(track.peak_streams) + '</td>';
            html += '<td class="px-4 py-2 text-sm text-right">';
            if (isRadio) {
                // For radio, show number of stations
                html += '<span class="text-gray-900 dark:text-white font-medium">' + (track.stations_count || 'N/A') + '</span>';
            } else {
                // For charts, show position badge
                if (track.best_position) {
                    html += '<span class="inline-flex items-center justify-center w-8 h-8 text-xs font-bold text-white bg-blue-600 rounded-full">';
                    html += '#' + track.best_position;
                    html += '</span>';
                } else {
                    html += '<span class="text-gray-400">N/A</span>';
                }
            }
            html += '</td>';
            html += '<td class="px-4 py-2 text-sm text-right text-gray-600 dark:text-gray-400">' + (track.weeks_on_chart || track.data_points || 'N/A') + '</td>';
            
            // Entry Date
            html += '<td class="px-4 py-2 text-sm text-center text-gray-600 dark:text-gray-400">';
            if (track.entry_date) {
                var entryDate = new Date(track.entry_date);
                html += entryDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else {
                html += '<span class="text-gray-400">N/A</span>';
            }
            html += '</td>';
            
            // Last Appearance
            html += '<td class="px-4 py-2 text-sm text-center text-gray-600 dark:text-gray-400">';
            if (track.last_appearance) {
                var lastDate = new Date(track.last_appearance);
                html += lastDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else {
                html += '<span class="text-gray-400">N/A</span>';
            }
            html += '</td>';
            
            html += '</tr>';
        });
        
        html += '</tbody>';
        html += '<tfoot class="bg-gray-50 dark:bg-gray-800 border-t-2 border-gray-300 dark:border-gray-600"><tr>';
        html += '<td class="px-4 py-2 text-sm font-bold text-gray-900 dark:text-white">TOTAL</td>';
        html += '<td class="px-4 py-2 text-sm text-right font-bold text-gray-900 dark:text-white">' + formatNumber(data.summary.total_streams) + '</td>';
        html += '<td colspan="6" class="px-4 py-2 text-xs text-right text-gray-500 dark:text-gray-400">';
        html += 'Average per track: ' + formatNumber(data.summary.avg_streams_per_track);
        html += '</td></tr></tfoot>';
        html += '</table></div>';
        html += '<p class="mt-3 text-xs text-gray-500 dark:text-gray-400">';
        html += '<strong>Note:</strong> ' + data.note;
        html += '</p>';
    } else {
        html += '<p class="text-gray-600 dark:text-gray-400">No track data available</p>';
    }
    
    html += '</div>';
    contentDiv.innerHTML = html;
}

function renderTrackBreakdownError(contentDiv, errorMessage) {
    let html = '<div class="p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">';
    html += '<p class="text-sm text-red-800 dark:text-red-200">' + errorMessage + '</p>';
    html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-2">';
    html += 'Track data is only available for songs that appeared in charts during the selected period.';
    html += '</p></div>';
    contentDiv.innerHTML = html;
}

function exportToExcel() {
    if (!window.currentSearchParams) {
        alert('No data to export');
        return;
    }
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Exporting...';
    
    fetch('/soundcharts/analytics/export/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(window.currentSearchParams)
    })
    .then(response => {
        if (!response.ok) throw new Error('Export failed');
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `music_analytics_${window.currentSearchParams.start_date}_${window.currentSearchParams.end_date}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Failed to export data');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-state').classList.remove('hidden');
    setTimeout(() => {
        document.getElementById('error-state').classList.add('hidden');
    }, 10000);  // Show longer for debugging
}

function showDetailedError(result) {
    let message = result.error || 'An error occurred';
    
    // If we have error details, create a more helpful message
    if (result.error_details) {
        const details = result.error_details;
        message = `${details.message}\n\n`;
        message += `Attempts: ${details.total_attempts} | Successful: ${details.successful} | Failed: ${details.failed}\n\n`;
        
        if (details.failures && details.failures.length > 0) {
            message += 'Issues:\n';
            details.failures.slice(0, 3).forEach(f => {
                message += `• ${f}\n`;
            });
        }
        
        if (details.suggestions && details.suggestions.length > 0) {
            message += '\nSuggestions:\n';
            details.suggestions.forEach(s => {
                message += `💡 ${s}\n`;
            });
        }
    }
    
    // Show error with detailed message
    document.getElementById('error-message').innerHTML = message.replace(/\n/g, '<br>');
    document.getElementById('error-state').classList.remove('hidden');
    
    // Don't auto-hide detailed errors
    console.error('Analytics error details:', result);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#artistSearch') && !e.target.closest('#artist-suggestions')) {
        const dropdown = document.getElementById('artist-suggestions');
        if (dropdown) {
            dropdown.classList.add('hidden');
        }
    }
});

// Set default dates to last COMPLETE month (e.g., September 2024)
const today = new Date();
const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1); // First day of last month
const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of last month

// Format as YYYY-MM-DD for date input
const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

document.getElementById('start-date').value = formatDate(lastMonth);
document.getElementById('end-date').value = formatDate(lastMonthEnd);
</script>

<style>
/* Tooltip Styles */
.tooltip-wrapper {
    position: relative;
    display: inline-flex;
}

.tooltip-wrapper .tooltip-text {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    z-index: 50;
    bottom: 125%;
    right: 0;
    width: 250px;
    background-color: #1f2937;
    color: #f9fafb;
    text-align: left;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    line-height: 1.4;
    transition: opacity 0.2s, visibility 0.2s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.tooltip-wrapper .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    right: 12px;
    border-width: 5px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
}

.tooltip-wrapper:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Dark mode adjustments */
.dark .tooltip-wrapper .tooltip-text {
    background-color: #374151;
    color: #f3f4f6;
}

.dark .tooltip-wrapper .tooltip-text::after {
    border-color: #374151 transparent transparent transparent;
}
</style>
{% endblock extra_js %}

