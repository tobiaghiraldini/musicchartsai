{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">

<main>
  <div class="px-4 pt-6">
    <!-- Header Section -->
    <div class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Music Analytics</h1>
          <p class="text-gray-600 dark:text-gray-400">Aggregate artist audience metrics across platforms and time periods</p>
        </div>
      </div>
    </div>

    <!-- Search Form -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-6 mb-6">
      <form id="analytics-search-form">
        <!-- Artists Selection -->
        <div class="mb-6">
          <label for="artistSearch" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Select Artists <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2 mb-2">
            <input type="text" 
                   id="artistSearch" 
                   placeholder="Search artists by name..." 
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                   autocomplete="off">
          </div>
          <div id="selected-artists" class="flex flex-wrap gap-2 mt-2 min-h-[40px]">
            <!-- Selected artists will appear here -->
          </div>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            ℹ️ Only artists with SoundCharts UUIDs can be selected (required for API access)
          </p>
        </div>

        <!-- Date Range -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="start-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              Start Date <span class="text-red-500">*</span>
            </label>
            <input type="date" 
                   id="start-date" 
                   name="start_date"
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                   required>
          </div>
          <div>
            <label for="end-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
              End Date <span class="text-red-500">*</span>
            </label>
            <input type="date" 
                   id="end-date" 
                   name="end_date"
                   class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                   required>
          </div>
        </div>

        <!-- Platforms Selection -->
        <div class="mb-6">
          <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Platforms <span class="text-red-500">*</span>
          </label>
          <div class="flex items-center mb-2">
            <input type="checkbox" 
                   id="select-all-platforms" 
                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600">
            <label for="select-all-platforms" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
              Select All
            </label>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
            {% for platform in platforms %}
            <div class="flex items-center p-2 border border-gray-200 rounded-lg dark:border-gray-700">
              <input type="checkbox" 
                     name="platform_ids" 
                     value="{{ platform.id }}" 
                     id="platform-{{ platform.id }}"
                     class="platform-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600">
              <label for="platform-{{ platform.id }}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
                {{ platform.name }}
              </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Country Filter (Informational) -->
        <div class="mb-6">
          <label for="country" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Country (Informational)
          </label>
          <select id="country" 
                  name="country"
                  class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">All Countries</option>
            {% for country_code in countries %}
            <option value="{{ country_code }}">{{ country_code }}</option>
            {% endfor %}
          </select>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            ℹ️ Shows audience data for the selected country (available for Spotify & YouTube). Leave blank for global data.
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex items-center gap-4">
          <button type="submit" 
                  id="search-button"
                  class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Analyze Metrics
          </button>
        </div>
      </form>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
      <div class="flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-blue-800 dark:text-blue-200">Analyzing metrics...</span>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-red-800 dark:text-red-200" id="error-message">An error occurred</span>
      </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="hidden">
      <!-- Results will be loaded here -->
    </div>
  </div>
</main>

{% endblock content %}

{% block extra_js %}
<script>
const CSRF_TOKEN = document.querySelector('[name=csrf-token]').content;

// Selected artists storage
let selectedArtists = [];
let artistSearchTimeout = null;

// Artist autocomplete
document.getElementById('artistSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        document.getElementById('artist-suggestions').classList.add('hidden');
        return;
    }
    
    // Debounce search
    clearTimeout(artistSearchTimeout);
    artistSearchTimeout = setTimeout(() => {
        searchArtists(query);
    }, 300);
});

function searchArtists(query) {
    fetch(`/soundcharts/analytics/api/artist-autocomplete/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.artists.length > 0) {
                displayArtistSuggestions(data.artists);
            }
        })
        .catch(error => console.error('Artist search error:', error));
}

function displayArtistSuggestions(artists) {
    // Create suggestions dropdown if it doesn't exist
    let dropdown = document.getElementById('artist-suggestions');
    if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'artist-suggestions';
        dropdown.className = 'absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg dark:bg-gray-700 dark:border-gray-600 max-h-60 overflow-y-auto';
        document.getElementById('artistSearch').parentElement.appendChild(dropdown);
    }
    
    dropdown.innerHTML = artists.map(artist => {
        const imageHtml = artist.imageUrl 
            ? `<img src="${artist.imageUrl}" class="w-10 h-10 rounded-full object-cover mr-3" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
               <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3 text-gray-600 dark:text-gray-300 font-bold" style="display:none;">${artist.name.charAt(0).toUpperCase()}</div>`
            : `<div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-3 text-gray-600 dark:text-gray-300 font-bold">${artist.name.charAt(0).toUpperCase()}</div>`;
        
        return `
        <div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer flex items-center" 
             onclick='selectArtist(${JSON.stringify(artist)})'>
            ${imageHtml}
            <div>
                <div class="text-sm font-medium text-gray-900 dark:text-white">${artist.name}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${artist.countryCode || 'N/A'}</div>
            </div>
        </div>
        `;
    }).join('');
    
    dropdown.classList.remove('hidden');
}

function selectArtist(artist) {
    // Check if already selected
    if (selectedArtists.find(a => a.id === artist.id)) {
        return;
    }
    
    selectedArtists.push(artist);
    renderSelectedArtists();
    
    // Clear search
    document.getElementById('artistSearch').value = '';
    document.getElementById('artist-suggestions').classList.add('hidden');
}

function removeArtist(artistId) {
    selectedArtists = selectedArtists.filter(a => a.id !== artistId);
    renderSelectedArtists();
}

function renderSelectedArtists() {
    const container = document.getElementById('selected-artists');
    container.innerHTML = selectedArtists.map(artist => {
        const imageHtml = artist.imageUrl 
            ? `<img src="${artist.imageUrl}" class="w-5 h-5 rounded-full object-cover mr-2" onerror="this.style.display='none';">`
            : `<div class="w-5 h-5 rounded-full bg-blue-200 dark:bg-blue-700 flex items-center justify-center mr-2 text-xs font-bold">${artist.name.charAt(0).toUpperCase()}</div>`;
        
        return `
        <div class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full dark:bg-blue-900 dark:text-blue-200">
            ${imageHtml}
            <span class="text-sm font-medium">${artist.name}</span>
            <button type="button" 
                    onclick="removeArtist(${artist.id})"
                    class="ml-2 text-blue-600 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-100">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        `;
    }).join('');
}

// Select all platforms
document.getElementById('select-all-platforms').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('.platform-checkbox');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});

// Form submission
document.getElementById('analytics-search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate
    if (selectedArtists.length === 0) {
        showError('Please select at least one artist');
        return;
    }
    
    const selectedPlatforms = Array.from(document.querySelectorAll('.platform-checkbox:checked')).map(cb => cb.value);
    if (selectedPlatforms.length === 0) {
        showError('Please select at least one platform');
        return;
    }
    
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    if (!startDate || !endDate) {
        showError('Please select both start and end dates');
        return;
    }
    
    // Submit
    submitAnalyticsSearch({
        artist_ids: selectedArtists.map(a => a.id),
        platform_ids: selectedPlatforms,
        start_date: startDate,
        end_date: endDate,
        country: document.getElementById('country').value
    });
});

function submitAnalyticsSearch(data) {
    // Show loading
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('search-button').disabled = true;
    
    fetch('/soundcharts/analytics/results/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw { status: response.status, data: err };
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Display results inline
            displayResults(result.data, data);
        } else {
            showDetailedError(result);
        }
    })
    .catch(error => {
        console.error('Analytics search error:', error);
        if (error.data) {
            showDetailedError(error.data);
        } else {
            showError('An error occurred while analyzing metrics: ' + error.message);
        }
    })
    .finally(() => {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('search-button').disabled = false;
    });
}

function displayResults(data, searchParams) {
    console.log('Displaying results:', data);
    
    // Format number helper
    const formatNumber = (value) => {
        if (!value) return 'N/A';
        if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
        if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
        if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
        return Math.floor(value).toLocaleString();
    };
    
    // Build period context
    const periodContext = searchParams.country 
        ? `${data.date_range.start} to ${data.date_range.end} | ${data.metadata.platforms.map(p => p.name).join(', ')} | ${searchParams.country}`
        : `${data.date_range.start} to ${data.date_range.end} | ${data.metadata.platforms.map(p => p.name).join(', ')} | Global`;
    
    const resultsHTML = `
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900/20 dark:border-blue-800">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
                ${data.metadata.artists.map(a => a.name).join(', ')}
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">
                📅 ${periodContext}
            </p>
        </div>

        <!-- Summary Cards with Tooltips -->
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6">
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Period Average</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Average monthly listeners/followers across the entire selected period. This is the typical daily count.</span>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${formatNumber(data.summary.average_daily)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Typical daily count</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Latest Value</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Most recent audience count (as of end date). Shows the current state at the end of the selected period.</span>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${formatNumber(data.summary.total_audience)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">As of ${data.date_range.end}</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Growth</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Change in audience from start to end of period. Positive = growing, Negative = declining.</span>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">
                    ${formatNumber(Math.abs(data.summary.total_audience - data.summary.average_daily))}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Period change</p>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400">Peak Performance</h3>
                    <div class="tooltip-wrapper">
                        <svg class="w-4 h-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="tooltip-text">Highest audience count during the selected period. Shows the best day's performance.</span>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">${formatNumber(data.summary.peak_value)}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Best day</p>
            </div>
        </div>

        <!-- Metric Explanations (Collapsible) -->
        <div class="mb-4">
            <button onclick="toggleExplanations(event)" 
                    class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                <svg id="explain-icon" class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                What do these metrics mean?
            </button>
            <div id="metric-explanations" class="hidden mt-2 p-4 bg-gray-50 border border-gray-200 rounded-lg dark:bg-gray-800 dark:border-gray-700">
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📊 Current</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Latest audience count as of the end date. For Spotify, this shows monthly listeners (28-day rolling window) at the end of your selected period.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">📈 Period Average</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Average monthly listeners/followers across all days in the selected period. Shows typical daily performance.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">🔼 Difference</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Change from start to end of period (Latest - First). Green = growing audience, Red = declining audience.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-1">⭐ Peak</h4>
                        <p class="text-gray-600 dark:text-gray-400">
                            Highest audience count during the selected period. Shows the best day's performance.
                        </p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                        <strong>📌 Important:</strong> Spotify uses "monthly listeners" which represents unique listeners over a 28-day rolling window. 
                        This is NOT total streams, but the count of unique people who listened.
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <strong>💡 To answer "How much in September?"</strong> Use the <strong>Period Average</strong> metric, 
                        which shows the typical monthly listeners throughout your selected month.
                        ${searchParams.country ? '<br><strong>🌍 Country Filter Active:</strong> Data shown is for ' + searchParams.country + ' only.' : ''}
                    </p>
                </div>
            </div>
        </div>

        <!-- Artist × Platform Breakdown -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">Artist × Platform Metrics</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            ${periodContext}
                        </p>
                    </div>
                    <button onclick="exportToExcel()" 
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Artist</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Platform</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Latest audience count as of end date">
                                    Current
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Average audience across period">
                                    Period Avg
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Change from start to end (growth)">
                                    Difference
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">
                                <span class="inline-flex items-center" title="Highest value in period">
                                    Peak
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                        ${data.detailed_breakdown.map(d => {
                            const diff = d.difference || 0;
                            const diffFormatted = diff >= 0 ? '+' + formatNumber(diff) : formatNumber(diff);
                            const diffColor = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                            
                            return `
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">${d.artist__name}</td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${d.platform__name}</td>
                                <td class="px-6 py-4 text-sm text-right text-gray-900 dark:text-white font-medium">${formatNumber(d.current_audience)}</td>
                                <td class="px-6 py-4 text-sm text-right text-gray-500 dark:text-gray-400">${formatNumber(d.month_average)}</td>
                                <td class="px-6 py-4 text-sm text-right font-medium ${diffColor}">${diffFormatted}</td>
                                <td class="px-6 py-4 text-sm text-right text-gray-500 dark:text-gray-400">${formatNumber(d.peak_value)}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('results-container').innerHTML = resultsHTML;
    document.getElementById('results-container').classList.remove('hidden');
    
    // Store data for Excel export
    window.currentAnalyticsData = data;
    window.currentSearchParams = searchParams;
    
    // Scroll to results
    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleExplanations(event) {
    event.preventDefault();
    const explanations = document.getElementById('metric-explanations');
    explanations.classList.toggle('hidden');
}

function exportToExcel() {
    if (!window.currentSearchParams) {
        alert('No data to export');
        return;
    }
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Exporting...';
    
    fetch('/soundcharts/analytics/export/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify(window.currentSearchParams)
    })
    .then(response => {
        if (!response.ok) throw new Error('Export failed');
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `music_analytics_${window.currentSearchParams.start_date}_${window.currentSearchParams.end_date}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Export error:', error);
        alert('Failed to export data');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalHTML;
    });
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-state').classList.remove('hidden');
    setTimeout(() => {
        document.getElementById('error-state').classList.add('hidden');
    }, 10000);  // Show longer for debugging
}

function showDetailedError(result) {
    let message = result.error || 'An error occurred';
    
    // If we have error details, create a more helpful message
    if (result.error_details) {
        const details = result.error_details;
        message = `${details.message}\n\n`;
        message += `Attempts: ${details.total_attempts} | Successful: ${details.successful} | Failed: ${details.failed}\n\n`;
        
        if (details.failures && details.failures.length > 0) {
            message += 'Issues:\n';
            details.failures.slice(0, 3).forEach(f => {
                message += `• ${f}\n`;
            });
        }
        
        if (details.suggestions && details.suggestions.length > 0) {
            message += '\nSuggestions:\n';
            details.suggestions.forEach(s => {
                message += `💡 ${s}\n`;
            });
        }
    }
    
    // Show error with detailed message
    document.getElementById('error-message').innerHTML = message.replace(/\n/g, '<br>');
    document.getElementById('error-state').classList.remove('hidden');
    
    // Don't auto-hide detailed errors
    console.error('Analytics error details:', result);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#artistSearch') && !e.target.closest('#artist-suggestions')) {
        const dropdown = document.getElementById('artist-suggestions');
        if (dropdown) {
            dropdown.classList.add('hidden');
        }
    }
});

// Set default dates to last COMPLETE month (e.g., September 2024)
const today = new Date();
const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1); // First day of last month
const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of last month

// Format as YYYY-MM-DD for date input
const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

document.getElementById('start-date').value = formatDate(lastMonth);
document.getElementById('end-date').value = formatDate(lastMonthEnd);
</script>

<style>
/* Tooltip Styles */
.tooltip-wrapper {
    position: relative;
    display: inline-flex;
}

.tooltip-wrapper .tooltip-text {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    z-index: 50;
    bottom: 125%;
    right: 0;
    width: 250px;
    background-color: #1f2937;
    color: #f9fafb;
    text-align: left;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    line-height: 1.4;
    transition: opacity 0.2s, visibility 0.2s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.tooltip-wrapper .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    right: 12px;
    border-width: 5px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
}

.tooltip-wrapper:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Dark mode adjustments */
.dark .tooltip-wrapper .tooltip-text {
    background-color: #374151;
    color: #f3f4f6;
}

.dark .tooltip-wrapper .tooltip-text::after {
    border-color: #374151 transparent transparent transparent;
}
</style>
{% endblock extra_js %}

