{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">

<main>
  <div class="px-4 pt-6">
    <!-- Header Section -->
    <div class="mb-6">
      <div class="flex items-center mb-4">
        <a href="{% url 'soundcharts:artist_list' %}" class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white mr-4">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Artists
        </a>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Artist Audience Analytics</h1>
      </div>
    </div>

    {% if error %}
    <!-- Error State -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-red-800 dark:text-red-200">{{ error }}</span>
      </div>
    </div>
    {% else %}

    <!-- Artist Information Card -->
    <div class="mb-6 p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800">
      <div class="flex items-start space-x-6">
        <!-- Artist Image -->
        <div class="flex-shrink-0">
          {% if artist.imageUrl %}
          <img class="w-32 h-32 rounded-lg object-cover" src="{{ artist.imageUrl }}" alt="{{ artist.name }}">
          {% else %}
          <div class="w-32 h-32 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center">
            <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
            </svg>
          </div>
          {% endif %}
        </div>
        
        <!-- Artist Details -->
        <div class="flex-1 min-w-0">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ artist.name }}</h2>
          
          <div class="flex flex-wrap gap-2 mb-4">
            {% if artist.countryCode %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
              üìç {{ artist.countryCode }}
            </span>
            {% endif %}
            {% if artist.careerStage %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                         {% if artist.careerStage == 'superstar' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200
                         {% elif artist.careerStage == 'mainstream' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                         {% elif artist.careerStage == 'mid_level' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                         {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200{% endif %}">
              {{ artist.careerStage }}
            </span>
            {% endif %}
            {% if artist.gender %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
              {{ artist.gender }}
            </span>
            {% endif %}
          </div>
          
          <!-- Artist Metadata -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm mb-4">
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">UUID:</span>
              <span class="text-gray-600 dark:text-gray-400 font-mono text-xs">{{ artist.uuid|truncatechars:20 }}</span>
            </div>
            {% if artist.cityName %}
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">City:</span>
              <span class="text-gray-600 dark:text-gray-400">{{ artist.cityName }}</span>
            </div>
            {% endif %}
            {% if artist.birthDate %}
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">Birth Date:</span>
              <span class="text-gray-600 dark:text-gray-400">{{ artist.birthDate|date:"M d, Y" }}</span>
            </div>
            {% endif %}
          </div>
          
          <!-- Biography -->
          {% if artist.biography %}
          <div class="mt-4">
            <div class="text-sm text-gray-700 dark:text-gray-300 biography-content">
              {{ artist.biography|safe }}
            </div>
          </div>
          {% endif %}
          
          <!-- Genres -->
          {% if artist.genres.exists %}
          <div class="mt-4">
            <span class="font-medium text-gray-700 dark:text-gray-300 text-sm">Genres:</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {% for genre in artist.genres.all %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                {{ genre.name }}
              </span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Audience Performance Section -->
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Audience Performance</h3>
      
      {% if platforms_data %}
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% for platform_data in platforms_data %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">{{ platform_data.platform.name }}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">{{ platform_data.platform.audience_metric_name }}</p>
            </div>
            <div class="text-right">
              {% if platform_data.latest_audience %}
              <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ platform_data.latest_audience.formatted_audience_value }}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400">{{ platform_data.latest_audience.date|date:"M d, Y" }}</p>
              {% else %}
              <p class="text-2xl font-bold text-gray-500 dark:text-gray-400">No Data</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Chart Container -->
          <div class="h-32 mb-4" id="chart-{{ platform_data.platform.slug }}" style="min-height: 128px;">
            <!-- Chart will be rendered here -->
          </div>
          
          <div class="mt-2 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
            <span id="data-points-{{ platform_data.platform.slug }}">{{ platform_data.data_points }} data points</span>
            <span id="date-range-{{ platform_data.platform.slug }}">Last 30 days</span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-12 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No audience data available</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">This artist doesn't have any audience data yet.</p>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Use the "Fetch Audience" button in the admin panel.</p>
      </div>
      {% endif %}
    </div>

    <!-- Related Tracks -->
    {% if related_tracks %}
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Tracks by {{ artist.name }}</h3>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {% for track in related_tracks %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
          <div class="flex items-center space-x-3">
            {% if track.image_url %}
            <img class="w-12 h-12 rounded-lg object-cover" src="{{ track.image_url }}" alt="{{ track.name }}">
            {% else %}
            <div class="w-12 h-12 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"></path>
              </svg>
            </div>
            {% endif %}
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ track.name }}</h4>
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ track.credit_name|default:"Unknown Artist" }}</p>
              <a href="{% url 'soundcharts:song_audience_detail' track.uuid %}" 
                 class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                View Analytics ‚Üí
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% endif %}
  </div>
</main>

{% endblock content %}

{% block extrastyle %}
<style>
/* Biography content styling */
.biography-content {
    line-height: 1.6;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 8px;
}

.biography-content::-webkit-scrollbar {
    width: 6px;
}

.biography-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.biography-content::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.biography-content::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Dark mode scrollbar */
.dark .biography-content::-webkit-scrollbar-track {
    background: #374151;
}

.dark .biography-content::-webkit-scrollbar-thumb {
    background: #6B7280;
}

.dark .biography-content::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
}

/* Style links in biography */
.biography-content a {
    color: #2563EB;
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: text-decoration-color 0.2s;
}

.biography-content a:hover {
    color: #1D4ED8;
    text-decoration-color: #1D4ED8;
}

.dark .biography-content a {
    color: #60A5FA;
}

.dark .biography-content a:hover {
    color: #93C5FD;
    text-decoration-color: #93C5FD;
}

/* Style paragraphs in biography */
.biography-content p {
    margin-bottom: 0.75rem;
}

.biography-content p:last-child {
    margin-bottom: 0;
}

/* Style bold text */
.biography-content strong,
.biography-content b {
    font-weight: 600;
    color: #111827;
}

.dark .biography-content strong,
.dark .biography-content b {
    color: #F9FAFB;
}

/* Style italic text */
.biography-content em,
.biography-content i {
    font-style: italic;
}
</style>
{% endblock extrastyle %}

{% block extra_js %}
<script>
// Prevent the audience charts manager from running on this page
window.AUDIENCE_CHARTS_DISABLED = true;

// Artist Detail Charts Manager - handles individual artist charts
class ArtistDetailChartsManager {
    constructor() {
        this.charts = new Map();
        this.init();
    }

    async init() {
        // Wait for ApexCharts to be available from the main bundle
        await this.waitForApexCharts();
        this.loadCharts();
    }

    waitForApexCharts() {
        return new Promise((resolve) => {
            if (typeof window.ApexCharts !== 'undefined') {
                console.log('ApexCharts is available from bundle');
                resolve();
                return;
            }
            
            console.log('Waiting for ApexCharts to load from bundle...');
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof window.ApexCharts !== 'undefined') {
                    console.log('ApexCharts loaded successfully from bundle');
                    clearInterval(checkInterval);
                    resolve();
                } else if (attempts > 30) { // 3 seconds timeout
                    console.error('ApexCharts failed to load from bundle after 3 seconds');
                    clearInterval(checkInterval);
                    resolve(); // Continue anyway
                }
            }, 100);
        });
    }

    loadCharts() {
        {% for platform_data in platforms_data %}
        this.loadChartData('{{ artist.uuid }}', '{{ platform_data.platform.slug }}', 'chart-{{ platform_data.platform.slug }}', {
            name: '{{ platform_data.platform.name }}',
            slug: '{{ platform_data.platform.slug }}',
            metric_name: '{{ platform_data.platform.audience_metric_name }}'
        });
        {% endfor %}
    }

    async loadChartData(artistUuid, platformSlug, chartId, platform) {
        try {
            const response = await fetch(`/soundcharts/artists/${artistUuid}/audience/chart/${platformSlug}/?limit=30`);
            const data = await response.json();
            
            if (data.success && data.chart_data) {
                this.renderChart(chartId, data.chart_data, platform);
                
                // Update latest value if element exists
                const latestValue = data.chart_data.datasets[0]?.data?.slice(-1)[0];
                if (latestValue) {
                    const chartElement = document.getElementById(chartId);
                    if (chartElement) {
                        const platformCard = chartElement.closest('.bg-white');
                        if (platformCard) {
                            const latestValueElement = platformCard.querySelector('#latest-value');
                            if (latestValueElement) {
                                latestValueElement.textContent = this.formatNumber(latestValue);
                            }
                        }
                    }
                }
            } else {
                this.renderEmptyChart(chartId, platform);
            }
        } catch (error) {
            console.error(`Error loading chart data for ${artistUuid} on ${platformSlug}:`, error);
            this.renderEmptyChart(chartId, platform);
        }
    }

    renderChart(chartId, chartData, platform) {
        console.log('Rendering chart for:', chartId, 'Data:', chartData, 'Platform:', platform);
        const chartColors = this.getChartColors();
        const platformColor = this.getPlatformColor(platform.slug);
        
        const options = {
            chart: {
                type: 'area',
                height: 140,
                fontFamily: 'Inter, sans-serif',
                foreColor: chartColors.labelColor,
                toolbar: {
                    show: false
                },
                zoom: {
                    enabled: true,
                    type: 'x',
                    autoScaleYaxis: true
                },
                pan: {
                    enabled: true,
                    type: 'x'
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                }
            },
            series: [{
                name: platform.metric_name || 'Followers',
                data: chartData.datasets[0].data.map((value, index) => ({
                    x: chartData.labels[index],
                    y: value
                }))
            }],
            colors: [platformColor],
            stroke: {
                curve: 'smooth',
                width: 3,
                lineCap: 'round'
            },
            fill: {
                type: 'gradient',
                gradient: {
                    enabled: true,
                    opacityFrom: chartColors.opacityFrom,
                    opacityTo: chartColors.opacityTo,
                    stops: [0, 100]
                }
            },
            markers: {
                size: 4,
                strokeColors: '#ffffff',
                strokeWidth: 2,
                hover: {
                    size: 6,
                    sizeOffset: 2
                }
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    show: true,
                    style: {
                        fontSize: '10px',
                        fontFamily: 'Inter, sans-serif',
                        colors: chartColors.labelColor
                    },
                    format: 'MMM dd',
                    rotate: -45
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    show: false
                }
            },
            grid: {
                show: false
            },
            tooltip: {
                enabled: true,
                style: {
                    fontSize: '12px',
                    fontFamily: 'Inter, sans-serif'
                },
                y: {
                    formatter: (value) => this.formatNumber(value)
                }
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                show: false
            }
        };

        // Destroy existing chart if it exists
        if (this.charts.has(chartId)) {
            this.charts.get(chartId).destroy();
        }

        // Create new chart
        const chart = new window.ApexCharts(document.getElementById(chartId), options);
        chart.render();
        this.charts.set(chartId, chart);
    }

    renderEmptyChart(chartId, platform) {
        const chartColors = this.getChartColors();
        
        const options = {
            chart: {
                type: 'area',
                height: 140,
                fontFamily: 'Inter, sans-serif',
                foreColor: chartColors.labelColor,
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: platform.metric_name || 'Followers',
                data: [0, 0, 0, 0, 0, 0, 0]
            }],
            colors: [chartColors.labelColor],
            stroke: {
                curve: 'smooth',
                width: 1
            },
            fill: {
                type: 'gradient',
                gradient: {
                    enabled: true,
                    opacityFrom: 0.1,
                    opacityTo: 0.05,
                    stops: [0, 100]
                }
            },
            xaxis: {
                categories: ['', '', '', '', '', '', ''],
                labels: {
                    show: false
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    show: false
                }
            },
            grid: {
                show: false
            },
            tooltip: {
                enabled: false
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                show: false
            },
            annotations: {
                yaxis: [{
                    y: 50,
                    borderColor: chartColors.labelColor,
                    label: {
                        text: 'No data available',
                        style: {
                            color: chartColors.labelColor,
                            fontSize: '12px'
                        }
                    }
                }]
            }
        };

        // Destroy existing chart if it exists
        if (this.charts.has(chartId)) {
            this.charts.get(chartId).destroy();
        }

        // Create new chart
        const chart = new window.ApexCharts(document.getElementById(chartId), options);
        chart.render();
        this.charts.set(chartId, chart);
    }

    getChartColors() {
        if (document.documentElement.classList.contains('dark')) {
            return {
                primary: '#1A56DB',
                primaryLight: '#3B82F6',
                secondary: '#10B981',
                secondaryLight: '#059669',
                labelColor: '#9CA3AF',
                borderColor: '#374151',
                opacityFrom: 0,
                opacityTo: 0.15
            };
        } else {
            return {
                primary: '#1A56DB',
                primaryLight: '#3B82F6',
                secondary: '#10B981',
                secondaryLight: '#34D399',
                labelColor: '#6B7280',
                borderColor: '#F3F4F6',
                opacityFrom: 0.45,
                opacityTo: 0
            };
        }
    }

    getPlatformColor(platformSlug) {
        const colors = {
            'spotify': '#1DB954',
            'apple_music': '#FA233B',
            'youtube': '#FF0000',
            'tiktok': '#000000',
            'soundcloud': '#FF5500',
            'deezer': '#00C7F2',
            'amazon_music': '#00A8E1',
            'pandora': '#224099',
            'instagram': '#E4405F',
            'facebook': '#1877F2',
            'twitter': '#1DA1F2'
        };
        
        return colors[platformSlug] || '#1A56DB';
    }

    formatNumber(value) {
        if (value >= 1_000_000_000) {
            return (value / 1_000_000_000).toFixed(1) + 'B';
        } else if (value >= 1_000_000) {
            return (value / 1_000_000).toFixed(1) + 'M';
        } else if (value >= 1_000) {
            return (value / 1_000).toFixed(1) + 'K';
        } else {
            return value.toLocaleString();
        }
    }
}

// Initialize the artist detail charts manager when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ArtistDetailChartsManager();
});
</script>
{% endblock extra_js %}

