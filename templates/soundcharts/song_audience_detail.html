{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">

<main>
  <div class="px-4 pt-6">
    <!-- Header Section -->
    <div class="mb-6">
      <div class="flex items-center mb-4">
        <a href="javascript:history.back()" class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white mr-4">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back
        </a>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Song Audience Analytics</h1>
      </div>
    </div>

    {% if error %}
    <!-- Error State -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-red-800 dark:text-red-200">{{ error }}</span>
      </div>
    </div>
    {% else %}

    <!-- Song Information Card -->
    <div class="mb-6 p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800">
      <div class="flex items-start space-x-6">
        <!-- Song Image -->
        <div class="flex-shrink-0">
          {% if track.image_url %}
          <img class="w-24 h-24 rounded-lg object-cover" src="{{ track.image_url }}" alt="{{ track.name }}">
          {% else %}
          <div class="w-24 h-24 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          {% endif %}
        </div>
        
        <!-- Song Details -->
        <div class="flex-1 min-w-0">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{{ track.name }}</h2>
          <p class="text-lg text-gray-600 dark:text-gray-400 mb-4">
            {% if track.artists.all %}
              {% for artist in track.artists.all %}
                <a href="{% url 'soundcharts:artist_detail' artist.uuid %}" 
                   class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline">
                  {{ artist.name }}
                </a>{% if not forloop.last %}, {% endif %}
              {% endfor %}
            {% elif track.primary_artist %}
              <a href="{% url 'soundcharts:artist_detail' track.primary_artist.uuid %}" 
                 class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline">
                {{ track.primary_artist.name }}
              </a>
            {% else %}
              {{ track.credit_name|default:"Unknown Artist" }}
            {% endif %}
          </p>
          
          <!-- Song Metadata -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">UUID:</span>
              <span class="text-gray-600 dark:text-gray-400 font-mono">{{ track.uuid|truncatechars:20 }}</span>
            </div>
            {% if track.release_date %}
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">Release Date:</span>
              <span class="text-gray-600 dark:text-gray-400">{{ track.release_date|date:"M d, Y" }}</span>
            </div>
            {% endif %}
            {% if track.duration %}
            <div>
              <span class="font-medium text-gray-700 dark:text-gray-300">Duration:</span>
              <span class="text-gray-600 dark:text-gray-400">{{ track.duration|floatformat:0 }}s</span>
            </div>
            {% endif %}
          </div>
          
          <!-- Genres -->
          {% if track.genres.exists %}
          <div class="mt-4">
            <span class="font-medium text-gray-700 dark:text-gray-300">Genres:</span>
            <div class="flex flex-wrap gap-2 mt-1">
              {% for genre in track.genres.all %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                {{ genre.name }}
              </span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Audience Performance Section -->
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Audience Performance</h3>
      
      {% if platforms_data %}
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {% for platform_data in platforms_data %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">{{ platform_data.platform.name }}</h4>
              <p class="text-sm text-gray-600 dark:text-gray-400">{{ platform_data.platform.audience_metric_name }}</p>
            </div>
            <div class="text-right">
              {% if platform_data.latest_audience %}
              <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ platform_data.latest_audience.formatted_audience_value }}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400">{{ platform_data.latest_audience.date|date:"M d, Y" }}</p>
              {% else %}
              <p class="text-2xl font-bold text-gray-500 dark:text-gray-400">No Data</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Chart Container -->
          <div class="h-32 mb-4" id="chart-{{ platform_data.platform.slug }}" style="min-height: 128px;">
            <!-- Chart will be rendered here -->
          </div>
          
          <div class="mt-2 flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
            <span id="data-points-{{ platform_data.platform.slug }}">{{ platform_data.data_points }} data points</span>
            <div class="flex items-center space-x-2">
              <span id="date-range-{{ platform_data.platform.slug }}">Last 30 days</span>
              <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" 
                      onclick="refreshPlatformData('{{ track.uuid }}', '{{ platform_data.platform.slug }}')">
                Refresh
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-12 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No audience data available</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">This track doesn't have any audience data yet.</p>
      </div>
      {% endif %}
    </div>

    <!-- Recent Chart Rankings -->
    {% if recent_rankings %}
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Recent Chart Rankings</h3>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-white">Chart</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-white">Position</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-white">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-white">Change</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
              {% for ranking in recent_rankings %}
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                  {{ ranking.ranking.chart.platform.name }} - {{ ranking.ranking.chart.name }} ({{ ranking.ranking.chart.frequency }})
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                  <span class="inline-flex items-center justify-center w-8 h-8 text-sm font-bold text-white bg-blue-600 rounded-full">
                    {{ ranking.position }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                  {{ ranking.ranking.ranking_date|date:"M d, Y" }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                  {% if ranking.position_change %}
                    {% if ranking.position_change > 0 %}
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                        ↑ +{{ ranking.position_change }}
                      </span>
                    {% elif ranking.position_change < 0 %}
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                        ↓ {{ ranking.position_change }}
                      </span>
                    {% else %}
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                        →
                      </span>
                    {% endif %}
                  {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                      New
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Related Tracks -->
    {% if related_tracks %}
    <div class="mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Related Tracks</h3>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {% for related_track in related_tracks %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 dark:bg-gray-800 p-4">
          <div class="flex items-center space-x-3">
            {% if related_track.image_url %}
            <img class="w-12 h-12 rounded-lg object-cover" src="{{ related_track.image_url }}" alt="{{ related_track.name }}">
            {% else %}
            <div class="w-12 h-12 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            {% endif %}
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ related_track.name }}</h4>
              {% if related_track.primary_artist %}
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                <a href="{% url 'soundcharts:artist_detail' related_track.primary_artist.uuid %}" 
                   class="hover:text-blue-600 dark:hover:text-blue-400">
                  {{ related_track.primary_artist.name }}
                </a>
              </p>
              {% else %}
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ related_track.credit_name|default:"Unknown Artist" }}</p>
              {% endif %}
              <a href="{% url 'soundcharts:song_audience_detail' related_track.uuid %}" 
                 class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                View Analytics →
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% endif %}
  </div>
</main>

{% endblock content %}

{% block extra_js %}
<script>
// Prevent the audience charts manager from running on this page
window.AUDIENCE_CHARTS_DISABLED = true;

// Song Detail Charts Manager - handles individual song charts
class SongDetailChartsManager {
    constructor() {
        this.charts = new Map();
        this.init();
    }

    async init() {
        // Wait for ApexCharts to be available from the main bundle
        await this.waitForApexCharts();
        this.loadCharts();
    }

    waitForApexCharts() {
        return new Promise((resolve) => {
            if (typeof window.ApexCharts !== 'undefined') {
                console.log('ApexCharts is available from bundle');
                resolve();
                return;
            }
            
            console.log('Waiting for ApexCharts to load from bundle...');
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof window.ApexCharts !== 'undefined') {
                    console.log('ApexCharts loaded successfully from bundle');
                    clearInterval(checkInterval);
                    resolve();
                } else if (attempts > 30) { // 3 seconds timeout
                    console.error('ApexCharts failed to load from bundle after 3 seconds');
                    clearInterval(checkInterval);
                    resolve(); // Continue anyway
                }
            }, 100);
        });
    }

    loadCharts() {
        {% for platform_data in platforms_data %}
        this.loadChartData('{{ track.uuid }}', '{{ platform_data.platform.slug }}', 'chart-{{ platform_data.platform.slug }}', {
            name: '{{ platform_data.platform.name }}',
            slug: '{{ platform_data.platform.slug }}',
            metric_name: '{{ platform_data.platform.audience_metric_name }}'
        });
        {% endfor %}
    }

    async loadChartData(trackUuid, platformSlug, chartId, platform) {
        try {
            const response = await fetch(`/soundcharts/audience/chart/${trackUuid}/${platformSlug}/?limit=30`);
            const data = await response.json();
            
            if (data.success && data.chart_data) {
                this.renderChart(chartId, data.chart_data, platform);
                
                // Update latest value if element exists
                const latestValue = data.chart_data.datasets[0]?.data?.slice(-1)[0];
                if (latestValue) {
                    const chartElement = document.getElementById(chartId);
                    if (chartElement) {
                        const platformCard = chartElement.closest('.bg-white');
                        if (platformCard) {
                            const latestValueElement = platformCard.querySelector('#latest-value');
                            if (latestValueElement) {
                                latestValueElement.textContent = this.formatNumber(latestValue);
                            }
                        }
                    }
                }
            } else {
                this.renderEmptyChart(chartId, platform);
            }
        } catch (error) {
            console.error(`Error loading chart data for ${trackUuid} on ${platformSlug}:`, error);
            this.renderEmptyChart(chartId, platform);
        }
    }

    renderChart(chartId, chartData, platform) {
        console.log('Rendering chart for:', chartId, 'Data:', chartData, 'Platform:', platform);
        const chartColors = this.getChartColors();
        const platformColor = this.getPlatformColor(platform.slug);
        
        const options = {
            chart: {
                type: 'area',
                height: 140,
                fontFamily: 'Inter, sans-serif',
                foreColor: chartColors.labelColor,
                toolbar: {
                    show: false
                },
                zoom: {
                    enabled: true,
                    type: 'x',
                    autoScaleYaxis: true
                },
                pan: {
                    enabled: true,
                    type: 'x'
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                }
            },
            series: [{
                name: platform.metric_name || 'Listeners',
                data: chartData.datasets[0].data.map((value, index) => ({
                    x: chartData.labels[index],
                    y: value
                }))
            }],
            colors: [platformColor],
            stroke: {
                curve: 'smooth',
                width: 3,
                lineCap: 'round'
            },
            fill: {
                type: 'gradient',
                gradient: {
                    enabled: true,
                    opacityFrom: chartColors.opacityFrom,
                    opacityTo: chartColors.opacityTo,
                    stops: [0, 100]
                }
            },
            markers: {
                size: 4,
                strokeColors: '#ffffff',
                strokeWidth: 2,
                hover: {
                    size: 6,
                    sizeOffset: 2
                }
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    show: true,
                    style: {
                        fontSize: '10px',
                        fontFamily: 'Inter, sans-serif',
                        colors: chartColors.labelColor
                    },
                    format: 'MMM dd',
                    rotate: -45
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    show: false
                }
            },
            grid: {
                show: false
            },
            tooltip: {
                enabled: true,
                style: {
                    fontSize: '12px',
                    fontFamily: 'Inter, sans-serif'
                },
                y: {
                    formatter: (value) => this.formatNumber(value)
                }
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                show: false
            }
        };

        // Destroy existing chart if it exists
        if (this.charts.has(chartId)) {
            this.charts.get(chartId).destroy();
        }

        // Create new chart
        const chart = new window.ApexCharts(document.getElementById(chartId), options);
        chart.render();
        this.charts.set(chartId, chart);
    }

    renderEmptyChart(chartId, platform) {
        const chartColors = this.getChartColors();
        
        const options = {
            chart: {
                type: 'area',
                height: 140,
                fontFamily: 'Inter, sans-serif',
                foreColor: chartColors.labelColor,
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: platform.metric_name || 'Listeners',
                data: [0, 0, 0, 0, 0, 0, 0]
            }],
            colors: [chartColors.labelColor],
            stroke: {
                curve: 'smooth',
                width: 1
            },
            fill: {
                type: 'gradient',
                gradient: {
                    enabled: true,
                    opacityFrom: 0.1,
                    opacityTo: 0.05,
                    stops: [0, 100]
                }
            },
            xaxis: {
                categories: ['', '', '', '', '', '', ''],
                labels: {
                    show: false
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    show: false
                }
            },
            grid: {
                show: false
            },
            tooltip: {
                enabled: false
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                show: false
            },
            annotations: {
                yaxis: [{
                    y: 50,
                    borderColor: chartColors.labelColor,
                    label: {
                        text: 'No data available',
                        style: {
                            color: chartColors.labelColor,
                            fontSize: '12px'
                        }
                    }
                }]
            }
        };

        // Destroy existing chart if it exists
        if (this.charts.has(chartId)) {
            this.charts.get(chartId).destroy();
        }

        // Create new chart
        const chart = new window.ApexCharts(document.getElementById(chartId), options);
        chart.render();
        this.charts.set(chartId, chart);
    }

    getChartColors() {
        if (document.documentElement.classList.contains('dark')) {
            return {
                primary: '#1A56DB',
                primaryLight: '#3B82F6',
                secondary: '#10B981',
                secondaryLight: '#059669',
                labelColor: '#9CA3AF',
                borderColor: '#374151',
                opacityFrom: 0,
                opacityTo: 0.15
            };
        } else {
            return {
                primary: '#1A56DB',
                primaryLight: '#3B82F6',
                secondary: '#10B981',
                secondaryLight: '#34D399',
                labelColor: '#6B7280',
                borderColor: '#F3F4F6',
                opacityFrom: 0.45,
                opacityTo: 0
            };
        }
    }

    getPlatformColor(platformSlug) {
        const colors = {
            'spotify': '#1DB954',
            'apple_music': '#FA233B',
            'youtube': '#FF0000',
            'tiktok': '#000000',
            'soundcloud': '#FF5500',
            'deezer': '#00C7F2',
            'amazon_music': '#00A8E1',
            'pandora': '#224099'
        };
        
        return colors[platformSlug] || '#1A56DB';
    }

    formatNumber(value) {
        if (value >= 1_000_000_000) {
            return (value / 1_000_000_000).toFixed(1) + 'B';
        } else if (value >= 1_000_000) {
            return (value / 1_000_000).toFixed(1) + 'M';
        } else if (value >= 1_000) {
            return (value / 1_000).toFixed(1) + 'K';
        } else {
            return value.toLocaleString();
        }
    }
}

// Function to refresh platform data
function refreshPlatformData(trackUuid, platformSlug) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Refreshing...';
    button.disabled = true;
    
    fetch(`/soundcharts/audience/refresh/${trackUuid}/${platformSlug}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated data
            location.reload();
        } else {
            alert('Failed to refresh data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to refresh data');
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Initialize the song detail charts manager when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new SongDetailChartsManager();
});
</script>
{% endblock extra_js %}
