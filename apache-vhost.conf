# Apache Virtual Host Configuration for Music Charts AI
# Place this file in /etc/apache2/sites-available/musiccharts.conf

<VirtualHost *:80>
    ServerName musicchartsai.ninjabit.com
    # ServerAlias www.musicchartsai.ninjabit.com
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://musicchartsai.ninjabit.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName musicchartsai.ninjabit.com
    # ServerAlias www.musicchartsai.ninjabit.com
    
    # SSL Configuration (update paths to your actual certificates)
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/musicchartsai.ninjabit.com.crt
    SSLCertificateKeyFile /etc/ssl/private/musicchartsai.ninjabit.com.key
    
    # Optional: SSL Certificate Chain (if you have one)
    # SSLCertificateChainFile /etc/ssl/certs/musicchartsai.ninjabit.com.chain.crt
    
    # SSL Security Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"
    
    # Document Root
    DocumentRoot /home/users/ninjabit/musicchartsai
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/musiccharts_error.log
    CustomLog ${APACHE_LOG_DIR}/musiccharts_access.log combined
    
    # Client max body size (for file uploads)
    LimitRequestBody 52428800  # 50MB
    
    # Static files - served directly by Apache
    Alias /static/ /home/users/ninjabit/musiccharts/staticfiles/
    <Directory /home/users/ninjabit/musiccharts/staticfiles/>
        Require all granted
        # Cache static files for 1 year
        ExpiresActive On
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType application/pdf "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        
        # Add cache headers
        Header set Cache-Control "public, max-age=31536000"
    </Directory>
    
    # Media files - served directly by Apache
    Alias /media/ /home/users/ninjabit/musiccharts/media/
    <Directory /home/users/ninjabit/musiccharts/media/>
        Require all granted
        # Cache media files for 1 month
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        Header set Cache-Control "public, max-age=2592000"
    </Directory>
    
    # Proxy to Gunicorn for Django application
    ProxyPreserveHost On
    ProxyPass /static/ !
    ProxyPass /media/ !
    ProxyPass / http://127.0.0.1:8080/
    ProxyPassReverse / http://127.0.0.1:8080/
    
    # Proxy headers
    ProxyPassReverse / http://127.0.0.1:8080/
    ProxyPreserveHost On
    
    # Set headers for Django
    RequestHeader set X-Forwarded-Proto https
    RequestHeader set X-Forwarded-Port 443
    
    # WebSocket support (if needed for real-time features)
    # RewriteEngine on
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/ws/(.*)$ ws://127.0.0.1:8000/ws/$1 [P,L]
    
    # Admin interface security (optional - restrict admin access by IP)
    # <Location /admin/>
    #     Require ip 192.168.1.0/24
    #     Require ip 10.0.0.0/8
    # </Location>
    
    # API rate limiting (optional)
    # <Location /api/>
    #     # Add rate limiting headers or use mod_evasive
    # </Location>
    
    # Health check endpoint (optional)
    <Location /health/>
        ProxyPass http://127.0.0.1:8080/health/
        ProxyPassReverse http://127.0.0.1:8080/health/
    </Location>
    
</VirtualHost>

# Optional: Additional virtual host for staging/testing
# <VirtualHost *:443>
#     ServerName staging.yourdomain.com
#     
#     # Same configuration as above but with different paths
#     DocumentRoot /home/users/ninjabit/musicchartsai/staging
#     
#     # ... rest of configuration
# </VirtualHost>
